openapi: 3.1.0
info:
  title: Compras Divididas API
  version: 0.1.0
  description: >
    Contrato REST para processar mensagens do WhatsApp, gerar fechamento mensal
    bilateral e consultar historico de reconciliacao.
servers:
  - url: http://localhost:8000
tags:
  - name: MonthlyClosures
    description: Operacoes de fechamento mensal e consulta historica.

paths:
  /v1/monthly-closures:
    post:
      tags: [MonthlyClosures]
      summary: Cria um fechamento mensal a partir de um lote de mensagens
      operationId: createMonthlyClosure
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateMonthlyClosureRequest'
      responses:
        '201':
          description: Fechamento criado com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MonthlyClosureReport'
        '400':
          description: Requisicao invalida
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Violacao de regra de negocio (ex. mais de dois participantes)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Erro de validacao de mensagens
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v1/monthly-closures/{closure_id}:
    get:
      tags: [MonthlyClosures]
      summary: Consulta um fechamento mensal por identificador
      operationId: getMonthlyClosureById
      parameters:
        - name: closure_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Fechamento encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MonthlyClosureReport'
        '404':
          description: Fechamento nao encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v1/monthly-closures/{year}/{month}/latest:
    get:
      tags: [MonthlyClosures]
      summary: Consulta o fechamento mais recente de um periodo
      operationId: getLatestMonthlyClosure
      parameters:
        - name: year
          in: path
          required: true
          schema:
            type: integer
            minimum: 2000
            maximum: 2100
        - name: month
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
            maximum: 12
      responses:
        '200':
          description: Fechamento encontrado para o periodo
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MonthlyClosureReport'
        '404':
          description: Nao existe fechamento para o periodo
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    Period:
      type: object
      required: [year, month]
      properties:
        year:
          type: integer
          minimum: 2000
          maximum: 2100
        month:
          type: integer
          minimum: 1
          maximum: 12

    ParticipantInput:
      type: object
      required: [external_id, display_name]
      properties:
        external_id:
          type: string
          minLength: 1
        display_name:
          type: string
          minLength: 1

    MessageInput:
      type: object
      required: [author_external_id, author_display_name, content]
      properties:
        message_id:
          type: string
        author_external_id:
          type: string
          minLength: 1
        author_display_name:
          type: string
          minLength: 1
        content:
          type: string
          minLength: 1
        sent_at:
          oneOf:
            - type: string
              format: date-time
            - type: 'null'

    CreateMonthlyClosureRequest:
      type: object
      required: [period, participants, messages]
      properties:
        period:
          $ref: '#/components/schemas/Period'
        participants:
          type: array
          minItems: 2
          maxItems: 2
          items:
            $ref: '#/components/schemas/ParticipantInput'
        messages:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/MessageInput'
        source:
          type: string
          enum: [manual_copy, whatsapp_export]
          default: manual_copy
        reprocess_mode:
          type: string
          enum: [new_version, replace_month]
          default: new_version

    ParticipantSummary:
      type: object
      required: [external_id, display_name]
      properties:
        external_id:
          type: string
        display_name:
          type: string

    ParticipantTotal:
      type: object
      required: [external_id, total_cents, total_brl]
      properties:
        external_id:
          type: string
        total_cents:
          type: integer
        total_brl:
          type: string

    TransferInstruction:
      type: object
      required: [amount_cents, amount_brl, message]
      properties:
        payer_external_id:
          oneOf:
            - type: string
            - type: 'null'
        receiver_external_id:
          oneOf:
            - type: string
            - type: 'null'
        amount_cents:
          type: integer
          minimum: 0
        amount_brl:
          type: string
        message:
          type: string

    ReconciliationCounts:
      type: object
      required: [valid, invalid, ignored, deduplicated]
      properties:
        valid:
          type: integer
          minimum: 0
        invalid:
          type: integer
          minimum: 0
        ignored:
          type: integer
          minimum: 0
        deduplicated:
          type: integer
          minimum: 0

    ValidEntry:
      type: object
      required:
        [entry_id, message_id, date, author_external_id, description, amount_cents, amount_brl, inferred_month]
      properties:
        entry_id:
          type: string
          format: uuid
        message_id:
          type: string
        date:
          type: string
          format: date-time
        author_external_id:
          type: string
        description:
          type: string
        amount_cents:
          type: integer
        amount_brl:
          type: string
        inferred_month:
          type: boolean

    RejectedEntry:
      type: object
      required: [entry_id, message_id, classification, reason_code, reason_message]
      properties:
        entry_id:
          type: string
          format: uuid
        message_id:
          type: string
        classification:
          type: string
          enum: [invalid, ignored]
        reason_code:
          type: string
        reason_message:
          type: string

    DeduplicatedEntry:
      type: object
      required: [entry_id, message_id, duplicated_of_entry_id, reason_message]
      properties:
        entry_id:
          type: string
          format: uuid
        message_id:
          type: string
        duplicated_of_entry_id:
          type: string
          format: uuid
        reason_message:
          type: string

    MonthlyClosureReport:
      type: object
      required:
        [closure_id, run_id, created_at, period, participants, totals_by_participant, transfer_instruction, counts]
      properties:
        closure_id:
          type: string
          format: uuid
        run_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [finalized, superseded]
        created_at:
          type: string
          format: date-time
        period:
          $ref: '#/components/schemas/Period'
        participants:
          type: array
          minItems: 2
          maxItems: 2
          items:
            $ref: '#/components/schemas/ParticipantSummary'
        totals_by_participant:
          type: array
          minItems: 2
          maxItems: 2
          items:
            $ref: '#/components/schemas/ParticipantTotal'
        transfer_instruction:
          $ref: '#/components/schemas/TransferInstruction'
        counts:
          $ref: '#/components/schemas/ReconciliationCounts'
        valid_entries:
          type: array
          items:
            $ref: '#/components/schemas/ValidEntry'
        rejected_entries:
          type: array
          items:
            $ref: '#/components/schemas/RejectedEntry'
        deduplicated_entries:
          type: array
          items:
            $ref: '#/components/schemas/DeduplicatedEntry'
        warnings:
          type: array
          items:
            type: string

    ErrorResponse:
      type: object
      required: [error_code, message]
      properties:
        error_code:
          type: string
        message:
          type: string
        details:
          type: array
          items:
            type: string
